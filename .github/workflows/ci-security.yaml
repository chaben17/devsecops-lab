name: DevSecOps Pipeline (Matrix)

on:
  push:
    branches: [ "main" ]
    # Le pipeline se lance si on touche √† l'un des services ou au pipeline lui-m√™me
    paths:
      - 'service_a/**'
      - 'service_b/**'
      - '.github/workflows/ci-security.yaml'

# Permissions pour Gitleaks, GHCR et le Push Git
permissions:
  contents: write
  packages: write
  security-events: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    strategy:
      # Si Service A √©choue, on laisse quand m√™me Service B continuer (false)
      fail-fast: false
      matrix:
        # üü¢ C'est ici que tu ajoutes tes nouveaux services
        service: [service_a, service_b]

    steps:
      # 1. Checkout
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. Gitleaks (Scan global)
      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          verbose: true

      # 3. Setup Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'

      # 4. Install Bandit
      - name: Install Security Tools
        run: pip install bandit

      # 5. Bandit (Cibl√© sur le dossier du service en cours)
      - name: Run Bandit (SAST)
        # On scanne uniquement le dossier du service concern√©
        run: bandit -r ./${{ matrix.service }}

      # 6. Trivy FS (Cibl√© sur le dossier du service)
      - name: Run Trivy vulnerability scanner (SCA)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './${{ matrix.service }}'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

      # 7. Build Docker Local (Pour le scan)
      - name: Build Local Image for Scanning
        run: |
          cd ${{ matrix.service }}
          # On tague l'image avec le nom du service (ex: service-b:latest)
          docker build -t ${{ matrix.service }}:latest .

      # 8. Scan Trivy Image
      - name: Run Trivy container scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ matrix.service }}:latest'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL'

      # 9. (Optionnel) DAST - Comment√© comme dans ton fichier
      # - name: Start Container for DAST
      #   run: |
      #     # Note: Il faudrait g√©rer les ports dynamiquement ici si activ√©
      #     docker run -d -p 8001:8001 --name ${{ matrix.service }}-test ${{ matrix.service }}:latest
      #     sleep 10

      # 10. Login GHCR
      - name: Log in to the Container registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 11. Build & Push GHCR
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          # On va chercher le Dockerfile dans le bon dossier
          context: ./${{ matrix.service }}
          push: true
          # On g√©n√®re les tags dynamiquement (repo/service-a ou repo/service-b)
          tags: |
            ghcr.io/${{ github.repository }}/${{ matrix.service }}:${{ github.sha }}
            ghcr.io/${{ github.repository }}/${{ matrix.service }}:latest

      # 12. Update Kubernetes Manifest (GitOps)
      - name: Update Kubernetes Manifest
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # D√©finition des variables dynamiques
          SERVICE_NAME="${{ matrix.service }}"
          IMAGE_NAME="ghcr.io/${{ github.repository }}/${SERVICE_NAME}:${{ github.sha }}"
          
          # On suppose que le fichier s'appelle service_b/k8s/service_b.yaml
          FILE_PATH="${SERVICE_NAME}/k8s/${SERVICE_NAME}.yaml"

          echo "Mise √† jour de $FILE_PATH avec l'image $IMAGE_NAME"

          # Remplacement
          sed -i "s|image: ghcr.io/.*|image: $IMAGE_NAME|g" $FILE_PATH
          
          # V√©rif
          cat $FILE_PATH | grep image:

          # Gestion des conflits potentiels (Pull avant Push)
          git pull origin main --rebase || true

          # Commit & Push
          git add $FILE_PATH
          git commit -m "Update ${SERVICE_NAME} image to ${{ github.sha }}" || echo "No changes to commit"
          git push

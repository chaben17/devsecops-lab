name: üõ°Ô∏è DAST - OWASP ZAP Scan
run-name: üõ°Ô∏è DAST - OWASP ZAP Scan
on:
  # Se lance apr√®s le succ√®s du workflow de d√©ploiement
  workflow_run:
    workflows: ["Deploy Apps to K3s"] # Remplacez par le nom exact de votre workflow de d√©ploiement
    types:
      - completed
  # Permet aussi un lancement manuel
  workflow_dispatch:
    inputs:
      reason:
        description: 'Raison du scan manuel'
        required: false
        default: 'V√©rification de s√©curit√© ponctuelle'

jobs:
  zap_scan:
    # On ne lance le scan que si le d√©ploiement a r√©ussi
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # Si un scan √©choue, les autres continuent
      matrix:
        include:
          - name: "Frontend"
            url: "https://d2xvxmkp0jsguh.cloudfront.net"  # Remplacez par vos URLs r√©elles
          - name: "Service-A"
            url: "https://devsecopslab.ddns.net/service-a/products"
          - name: "Service-B"
            url: "https://devsecopslab.ddns.net/service-b/products/"

    name: Scan ${{ matrix.name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: List files for debug
        if: always()
        run: |
          echo "R√©pertoire actuel : $(pwd)"
          ls -la
      - name: Wait for ${{ matrix.name }} to be ready
        run: |
          echo "Attente que l'URL ${{ matrix.url }} soit disponible..."
          timeout 180s bash -c 'until curl -sk ${{ matrix.url }}; do sleep 10; done'

      - name: üõ°Ô∏è OWASP ZAP Baseline Scan - ${{ matrix.name }}
        uses: zaproxy/action-baseline@v0.12.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          target: ${{ matrix.url }}
          artifact_name: 'zap_report_${{ matrix.name }}'
          # On cr√©e une issue GitHub pour chaque vuln√©rabilit√© trouv√©e
          issue_title: "Security Alert: DAST Findings for ${{ matrix.name }}"
          # On ignore les alertes de faible niveau pour √©viter le bruit
          fail_action: true
          rules_file_name: 'zap-rules.conf'
      - name: List files for debug
        if: always()
        run: |
          echo "R√©pertoire actuel : $(pwd)"
          ls -la

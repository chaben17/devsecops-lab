<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>DevSecOps Lab Shop</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
        .box { border: 1px solid #ccc; padding: 1.5rem; margin-bottom: 1.5rem; border-radius: 8px; }
        .hidden { display: none; }
        button { cursor: pointer; padding: 5px 10px; background-color: #007bff; color: white; border: none; border-radius: 4px; }
        button:hover { background-color: #0056b3; }
        input { padding: 5px; margin: 5px 0; }
        #response-area { background: #f4f4f4; padding: 10px; border-left: 5px solid #007bff; white-space: pre-wrap; }
        .error { color: red; }
    </style>
</head>
<body>

    <h1>üõí DevSecOps Shop Interface</h1>

    <div id="login-section" class="box">
        <h2>üîê Connexion (SSO)</h2>
        <input type="text" id="username" placeholder="Utilisateur (ex: user2)" value="user2">
        <input type="password" id="password" placeholder="Mot de passe" value="1234">
        <button onclick="login()">Se connecter</button>
        <p id="login-status"></p>
    </div>

    <div id="dashboard-section" class="box hidden">
        <h2>üöÄ Actions</h2>
        <p>Connect√© en tant que : <strong id="user-display"></strong></p>
        <p>Token (complet) : <code id="token-display" style="word-break: break-all; font-size: 0.8em;"></code></p>
        
        <hr>

        <h3>Lecture (Service B)</h3>
        <input type="text" id="prod-id" placeholder="ID Produit (ex: 178)" value="178">
        <button onclick="readProduct()">üîç Lire le produit</button>

        <h3>√âcriture (Service A)</h3>
        <input type="text" id="new-prod-id" placeholder="ID" value="999">
        <input type="text" id="new-prod-name" placeholder="Nom" value="Produit Web">
        <button onclick="addProduct()">‚ûï Ajouter le produit</button>

        <h3>R√©sultat de l'API :</h3>
        <div id="response-area">En attente d'action...</div>
        
        <br>
        <button onclick="logout()" style="background-color: #6c757d;">Se d√©connecter</button>
    </div>

    <script>
        let accessToken = null;

        // URL Keycloak via le Domaine Ingress
        const KEYCLOAK_URL = "http://devsecops.local:8080/realms/devsecops/protocol/openid-connect/token";
        
        // URLs des Services via le Domaine Ingress (Routing par chemin)
        const SERVICE_A_URL = "http://devsecops.local/service-a/products/";
        const SERVICE_B_URL = "http://devsecops.local/service-b/products/";

        async function login() {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const status = document.getElementById('login-status');

            const params = new URLSearchParams();
            params.append('client_id', 'myclient');
            params.append('username', user);
            params.append('password', pass);
            params.append('grant_type', 'password');

            try {
                const response = await fetch(KEYCLOAK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                });

                const data = await response.json();

                if (response.ok) {
                    accessToken = data.access_token;
                    showDashboard(user);
                } else {
                    status.innerHTML = `<span class="error">Erreur: ${data.error_description || 'Login failed'}</span>`;
                }
            } catch (error) {
                status.innerHTML = `<span class="error">Erreur R√©seau : V√©rifiez votre fichier hosts et le tunnel Ingress.<br>${error.message}</span>`;
                console.error(error);
            }
        }

        async function readProduct() {
            const id = document.getElementById('prod-id').value;
            // Appel vers Service B via Ingress
            callApi(`${SERVICE_B_URL}${id}`, 'GET');
        }

        async function addProduct() {
            const id = document.getElementById('new-prod-id').value;
            const name = document.getElementById('new-prod-name').value;
            const body = { id: id, nom: name, type: "Web", prix: 50.0 };
            // Appel vers Service A via Ingress
            callApi(SERVICE_A_URL, 'POST', body);
        }

        async function callApi(url, method, body = null) {
            const responseArea = document.getElementById('response-area');
            responseArea.innerText = "Chargement...";
            responseArea.style.borderLeftColor = "#007bff";

            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + accessToken
                    }
                };
                if (body) options.body = JSON.stringify(body);

                const response = await fetch(url, options);
                const data = await response.json();
                
                responseArea.innerText = JSON.stringify(data, null, 2); 

                if (!response.ok) {
                    responseArea.style.borderLeftColor = "red";
                } else {
                    responseArea.style.borderLeftColor = "green";
                }

            } catch (error) {
                responseArea.innerText = "Erreur technique : " + error.message + "\n(V√©rifiez que le tunnel Ingress est ouvert)";
                responseArea.style.borderLeftColor = "red";
            }
        }

        function showDashboard(user) {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            document.getElementById('user-display').innerText = user;
            // Affichage du token complet comme demand√©
            document.getElementById('token-display').innerText = accessToken;
        }

        function logout() {
            accessToken = null;
            location.reload();
        }
    </script>
</body>
</html>
